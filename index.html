<!DOCTYPE html>
<html lang="ur" dir="rtl" id="mainHtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faiz-ul-Quran Portal</title>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary-blue: #2d4396;
            --accent-orange: #ff8a3d;
            --bg-light: #f4f7f6;
            --nav-bg: #ffffff;
        }

        body {
            font-family: 'Noto Nastaliq Urdu', 'Roboto', sans-serif;
            background-color: var(--bg-light);
            margin: 0;
            padding-bottom: 90px;
        }

        header {
            background-color: var(--primary-blue);
            color: white;
            text-align: center;
            padding: 20px 10px;
            border-bottom: 4px solid var(--accent-orange);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .container {
            display: flex;
            justify-content: center;
            padding: 15px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
        }

        h3 {
            text-align: center;
            color: var(--primary-blue);
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary-blue);
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: inherit;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        .hidden { display: none; }

        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 70px;
            background-color: var(--nav-bg);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            border-top: 1px solid #ddd;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #666;
            cursor: pointer;
            flex: 1;
        }

        .nav-item.active { color: var(--primary-blue); }
        .nav-item i { font-size: 18px; }
        .nav-item span { font-size: 11px; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            border-bottom: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }

        th { background: #f0f0f0; }

        .lang-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: white;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>

<body>

<header>
    <h2 id="schoolName">فیض القرآن ہائی سکول</h2>
</header>

<div class="container">

    <!-- HOME -->
    <div id="homeScreen" class="card">
        <h3 id="homeTitle">خوش آمدید</h3>
        <p id="homeDesc" style="text-align:center;">
            ایڈمیشن پورٹل میں خوش آمدید۔ نیچے مینو استعمال کریں۔
        </p>
    </div>

    <!-- ADMISSION -->
    <div id="admissionScreen" class="card hidden">
        <h3 id="formTitle">داخلہ فارم</h3>

        <div class="form-group">
            <label id="lblAdm">داخلہ نمبر</label>
            <input id="admNo">
        </div>

        <div class="form-group">
            <label id="lblName">طالب علم کا نام</label>
            <input id="stdName">
        </div>

        <div class="form-group">
            <label id="lblFather">والد کا نام</label>
            <input id="fatherName">
        </div>

        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1;">
                <label id="lblClass">کلاس</label>
                <input id="stdClass">
            </div>
            <div class="form-group" style="flex:1;">
                <label id="lblSection">سیکشن</label>
                <input id="stdSection">
            </div>
        </div>

        <div class="form-group">
            <label id="lblRoll">رول نمبر</label>
            <input id="rollNo">
        </div>

        <div class="form-group">
            <label id="lblDob">تاریخ پیدائش</label>
            <input type="date" id="dob">
        </div>

        <button class="submit-btn" id="saveBtn" onclick="saveData()">محفوظ کریں</button>
    </div>

    <!-- SEARCH -->
    <div id="searchScreen" class="card hidden">
        <h3 id="searchTitle">ریکارڈ تلاش کریں</h3>
        <input id="searchInp" placeholder="داخلہ نمبر">
        <button class="submit-btn" style="margin-top:10px;" onclick="searchRecord()">تلاش کریں</button>
        <div id="searchResult" style="margin-top:10px;"></div>
    </div>

    <!-- VIEW -->
    <div id="viewScreen" class="card hidden">
        <h3 id="viewTitle">محفوظ شدہ ریکارڈ</h3>
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
            
            <button onclick="exportToCSV()" style="flex: 1; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                <i class="fa-solid fa-file-export"></i> Export CSV
            </button>
    
            <label for="csvFileInput" style="flex: 1; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px;">
                <i class="fa-solid fa-file-import"></i> Import CSV
            </label>
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
            
        </div>
        <table dir="ltr">
            <thead>
                <tr>
                    <th>Adm</th>
                    <th>Name</th>
                    <th>Class</th>
                    <th>Roll</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="recordsTable"></tbody>
        </table>
    </div>

</div>

<!-- NAV -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="navigate('homeScreen', this)">
        <i class="fa-solid fa-house"></i><span id="txtHome">ہوم</span>
    </div>
    <div class="nav-item" onclick="navigate('admissionScreen', this)">
        <i class="fa-solid fa-user-plus"></i><span id="txtAdd">نیا داخلہ</span>
    </div>
    <div class="nav-item" onclick="navigate('searchScreen', this)">
        <i class="fa-solid fa-magnifying-glass"></i><span id="txtSearch">تلاش</span>
    </div>
    <div class="nav-item" onclick="navigate('viewScreen', this); loadRecords()">
        <i class="fa-solid fa-table"></i><span id="txtView">ریکارڈ</span>
    </div>
</nav>

<script>
let lang = 'ur';

function navigate(id, el){
    document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    el.classList.add('active');
}

function saveData(){
    let data = JSON.parse(localStorage.getItem('admissions')) || [];
    //check for duplicate adm no then update
    let existingIndex = data.findIndex(x=>x.adm===admNo.value);
    if(existingIndex!==-1){
        data[existingIndex] = {
            adm: admNo.value,
            name: stdName.value,
            father: fatherName.value,
            class: stdClass.value,
            section: stdSection.value,
            roll: rollNo.value,
            dob: dob.value
        };
        localStorage.setItem('admissions', JSON.stringify(data));
        alert("Updated");
        document.querySelectorAll('#admissionScreen input').forEach(i=>i.value='');
        return;
    }
    data.push({
        adm: admNo.value,
        name: stdName.value,
        father: fatherName.value,
        class: stdClass.value,
        section: stdSection.value,
        roll: rollNo.value,
        dob: dob.value
    });
    localStorage.setItem('admissions', JSON.stringify(data));
    alert("Saved");
    document.querySelectorAll('#admissionScreen input').forEach(i=>i.value='');
}

function loadRecords(){
    let data = JSON.parse(localStorage.getItem('admissions')) || [];
    recordsTable.innerHTML = data.length
        ? data.map(r=>`<tr><td>${r.adm}</td><td>${r.name}</td><td>${r.class}</td><td>${r.roll}</td> 
            <td><button onclick="editRecord('${r.adm}')">Edit</button> <button onclick="deleteRecord('${r.adm}')">Delete</button></td>
            </tr>`).join('')
        : `<tr><td colspan="5">No Data</td></tr>`;
}

function searchRecord(){
    let adm = searchInp.value;
    let data = JSON.parse(localStorage.getItem('admissions')) || [];
    let r = data.find(x=>x.adm===adm);
    var isFound = r ? true : false;
    if(isFound){
        //create a table to show details 2 columns and row for each field
        var table = '<table style="width:100%; border-collapse: collapse;" dir="ltr">';
        for(var key in r){
            table += `<tr><td style="border: 1px solid #ddd; padding: 8px; font-weight:bold;">${key.charAt(0).toUpperCase() + key.slice(1)}</td><td style="border: 1px solid #ddd; padding: 8px;">${r[key]}</td></tr>`;
        }
        table += '</table>';
        searchResult.innerHTML = table;
    }else{
        searchResult.innerHTML = 'Not Found';
    }
}

function toggleLanguage(){
    lang = lang==='ur'?'en':'ur';
    mainHtml.dir = lang==='ur'?'rtl':'ltr';
    langBtn.innerText = lang==='ur'?'English':'اردو';
}

function editRecord(adm){
    let data = JSON.parse(localStorage.getItem('admissions')) || [];
    let r = data.find(x=>x.adm===adm);
    if(r){
        navigate('admissionScreen', document.querySelector('.nav-item:nth-child(2)'));
        admNo.value = r.adm;
        stdName.value = r.name;
        fatherName.value = r.father;
        stdClass.value = r.class;
        stdSection.value = r.section;
        rollNo.value = r.roll;
        dob.value = r.dob;
    }
}
function deleteRecord(adm){
    var confirmDelete = confirm("Are you sure you want to delete this record?");
    if (!confirmDelete) return;
    let data = JSON.parse(localStorage.getItem('admissions')) || [];
    data = data.filter(x=>x.adm!==adm);
    localStorage.setItem('admissions', JSON.stringify(data));
    loadRecords();
}

function exportToCSV() {
    const data = JSON.parse(localStorage.getItem('admissions')) || [];
    if (data.length === 0) {
        alert("No data found to export!");
        return;
    }

    // 1. Define Headers
    const headers = ["adm", "name", "father", "class", "section", "roll", "dob", "added_on", "updated_on"];
    
    // 2. Build CSV Content
    const csvRows = [];
    csvRows.push(headers.join(',')); // Add header row

    for (const row of data) {
        const values = headers.map(header => {
            const val = row[header] || '';
            // Escape quotes and wrap in quotes to handle commas inside text
            return `"${String(val).replace(/"/g, '""')}"`;
        });
        csvRows.push(values.join(','));
    }

    const csvString = csvRows.join('\n');
    
    // 3. Create Download Link
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "student_records.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function importFromCSV(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split('\n').filter(row => row.trim() !== '');
        
        // Assume first row is header: adm, name, father, class, section, roll, dob
        const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const jsonData = [];

        for (let i = 1; i < rows.length; i++) {
            // Regex to handle commas inside quotes correctly
            const values = rows[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
            let obj = {};
            
            headers.forEach((header, index) => {
                let val = values[index] ? values[index].trim() : "";
                obj[header] = val.replace(/^"|"$/g, ''); // Remove surrounding quotes
            });
            
            if (obj.adm) jsonData.push(obj);
        }

        if (jsonData.length > 0) {
            localStorage.setItem('admissions', JSON.stringify(jsonData));
            alert("Data Imported Successfully! Refreshing page...");
            location.reload(); 
        }
    };
    reader.readAsText(file);
}
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbylhZE18FfCS4od4k7T_tq0XSqUO6jlrrTElNwCHHRML9_h_o_OkrHvS3zHoED64eVbYQ/exec";
    https://script.google.com/macros/s/AKfycbylhZE18FfCS4od4k7T_tq0XSqUO6jlrrTElNwCHHRML9_h_o_OkrHvS3zHoED64eVbYQ/exec

// 1. Function to send data to Google Sheets
async function syncToSheets() {
    let data = JSON.parse(localStorage.getItem('admissions')) || [];
    try {
        await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data)
        });
        console.log("Synced to Cloud");
    } catch (error) {
        console.error("Sync failed", error);
    }
}

// 2. Function to pull data from Google Sheets on Load
async function pullFromSheets() {
    try {
        const response = await fetch(SCRIPT_URL);
        const remoteData = await response.json();
        if(remoteData.length > 0) {
            localStorage.setItem('admissions', JSON.stringify(remoteData));
            if(typeof loadRecords === "function") loadRecords();
        }
    } catch (error) {
        console.error("Initial pull failed", error);
    }
}

window.onload = () => {
    syncToSheets();
};
</script>

</body>
</html>





